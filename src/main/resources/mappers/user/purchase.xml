<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="LacunaMatata.Lacuna.repository.user.PurchaseMapper">
    <resultMap id="productUpperResultMap" type="LacunaMatata.Lacuna.dto.response.user.purchase.RespProductUpperCategoryDto">
        <id property="productUpperCategoryId" column="product_upper_category_id" />
        <result property="productUpperCategoryName" column="product_upper_category_name" />
        <collection property="productLowerCategory" javaType="java.util.ArrayList" resultMap="productLowerResultMap" />
    </resultMap>
    <resultMap id="productLowerResultMap" type="LacunaMatata.Lacuna.dto.response.user.purchase.RespProductLowerCategoryDto">
        <id property="productLowerCategoryId" column="product_lower_category_id" />
        <result property="productLowerCategoryName" column="product_lower_category_name" />
        <collection property="consultingProduct" javaType="java.util.ArrayList" resultMap="consultingProductResultMap" />
    </resultMap>
    <resultMap id="consultingProductResultMap" type="LacunaMatata.Lacuna.dto.response.user.purchase.RespConsultingProductDto">
        <id property="productId" column="product_id" />
        <result property="productCode" column="product_code" />
        <result property="productName" column="product_name" />
        <result property="price" column="price" />
        <result property="promotionPrice" column="promotion_price" />
        <result property="description" column="description" />
        <result property="etc" column="etc" />
        <result property="productImg" column="product_img" />
        <collection property="consultingDetail" resultMap="consultingDetailResultMap" />
    </resultMap>
    <resultMap id="consultingDetailResultMap" type="LacunaMatata.Lacuna.dto.response.user.purchase.RespConsultingDetailProductDto">
        <id property="consultingDetailId" column="consulting_detail_id" />
        <result property="consultingDetailContentId" column="consulting_detail_content_id" />
        <result property="repeatCount" column="repeat_count" />
        <result property="name" column="name" />
    </resultMap>

    <select id="getConsultingProductList" resultMap="productUpperResultMap">
        select
            puc.product_upper_category_id,
            puc.product_upper_category_name,
            plc.product_lower_category_id,
            plc.product_lower_category_name,
            p.product_id,
            p.product_code,
            p.product_name,
            p.price,
            p.promotion_price,
            p.description,
            p.etc,
            p.product_img,
            cd.consulting_detail_id,
            cd.consulting_detail_content_id,
            cd.repeat_count,
            (select name
            from tb_consulting_content cc
            where cc.consulting_content_id = cd.consulting_detail_content_id) as name
        from
            tb_product_upper_category puc
            left outer join tb_product_lower_category plc on plc.product_upper_category_id = puc.product_upper_category_id
            left outer join tb_product p on p.product_lower_category_id = plc.product_lower_category_id
            left outer join tb_consulting_detail cd on cd.consulting_detail_product_id = p.product_id
        where
            puc.product_upper_category_id = 1
    </select>
</mapper>